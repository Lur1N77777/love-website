<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我们的恋爱小屋</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13/dist/av-live-query-min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Gaegu', cursive;
            background: linear-gradient(170deg, #ffdde1 0%, #ffc4c8 100%);
            -webkit-tap-highlight-color: transparent;
        }
        .font-chinese { font-family: 'ZCOOL KuaiLe', cursive; }
        .bg-sweet-pink { background-color: #ffafcc; }
        .bg-sweet-blue { background-color: #a2d2ff; }
        .bg-sweet-yellow { background-color: #fff1a8; }
        .bg-sweet-green { background-color: #cdffcd; }
        .text-sweet-brown { color: #7c5c53; }
        .border-sweet-pink { border-color: #ffafcc; }
        .border-sweet-blue { border-color: #a2d2ff; }
        .bg-warm-white { background-color: #FFFCF9; }
        .bg-glass-effect {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(236, 72, 153, 0.15);
        }
        .fade-in { animation: fadeIn 1s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-bg { background-color: rgba(0, 0, 0, 0.5); }
        .diary-image { max-height: 300px; object-fit: cover; }
        .btn-disabled { cursor: not-allowed; background-color: #d1d5db; }

        /* 新增的用户选择器样式 */
        .user-select-btn {
            background-color: #ffffff;
            color: #a38f85;
            font-size: 1.1rem;
            font-weight: bold;
            border: 2px solid transparent;
        }
        .user-select-btn.selected {
            border-color: #ffafcc;
            color: #7c5c53;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- 主内容区 -->
    <main id="main-content" class="w-full max-w-4xl mx-auto">
        <div class="bg-glass-effect rounded-3xl p-6 md:p-10 space-y-8 fade-in">
            <!-- 头部 -->
            <header class="text-center">
                <h1 class="text-4xl md:text-5xl font-bold text-sweet-brown font-chinese">💖 我们的恋爱小屋 💖</h1>
                <p class="text-gray-500 mt-2 text-lg">记录我们在一起的每分每秒</p>
            </header>
            
            <!-- 新增的用户选择器 -->
            <section id="user-selector" class="text-center">
                <h3 class="font-bold text-lg mb-4 text-sweet-brown font-chinese">今天是谁在记录呀？</h3>
                <div class="inline-flex rounded-xl shadow-sm">
                    <button id="select-her" onclick="selectUser('her')" class="user-select-btn px-6 py-3 rounded-l-xl transition-all duration-300">
                        <span class="text-xl mr-2">👑</span> 小一二
                    </button>
                    <button id="select-him" onclick="selectUser('him')" class="user-select-btn px-6 py-3 rounded-r-xl transition-all duration-300">
                        <span class="text-xl mr-2">🛡️</span> 小布布
                    </button>
                </div>
            </section>

            <!-- 恋爱计时器 -->
            <section id="love-timer" class="bg-sweet-yellow p-6 rounded-2xl shadow-md text-center">
                 <h2 class="text-xl font-bold text-sweet-brown mb-4 font-chinese flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sweet-brown"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    我们已经相爱了
                </h2>
                <div id="timer-display" class="flex justify-center items-center space-x-2 md:space-x-4 text-sweet-brown">
                    <div class="text-center"><span id="days" class="text-4xl md:text-6xl font-bold">0</span><p>天</p></div>
                    <div class="text-4xl md:text-6xl font-bold">:</div>
                    <div class="text-center"><span id="hours" class="text-4xl md:text-6xl font-bold">0</span><p>时</p></div>
                    <div class="text-4xl md:text-6xl font-bold">:</div>
                    <div class="text-center"><span id="minutes" class="text-4xl md:text-6xl font-bold">0</span><p>分</p></div>
                    <div class="text-4xl md:text-6xl font-bold">:</div>
                    <div class="text-center"><span id="seconds" class="text-4xl md:text-6xl font-bold">0</span><p>秒</p></div>
                </div>
                <div class="mt-4 text-gray-500">
                    始于: <span id="start-date-display">...</span>
                </div>
                <button onclick="toggleSetDate()" class="mt-4 bg-white text-sweet-brown px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50 transition">设置/修改纪念日</button>
                <div id="date-setter" class="hidden mt-4 space-y-2 max-w-sm mx-auto">
                    <input type="datetime-local" id="love-start-date" class="w-full border-2 border-gray-200 p-2 rounded-lg focus:outline-none focus:border-sweet-blue">
                    <button onclick="setLoveStartDate()" class="w-full bg-sweet-blue text-white py-2 rounded-lg hover:bg-opacity-80 transition">保存</button>
                </div>
            </section>

            <!-- 恋爱日记 -->
            <section id="love-diary">
                <h2 class="text-2xl font-bold text-sweet-brown text-center mb-6 font-chinese flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sweet-brown"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                    我们的甜蜜日记
                </h2>
                
                <div class="bg-warm-white p-6 rounded-2xl shadow-md mb-8">
                    <h3 class="font-bold text-lg mb-4 text-sweet-brown font-chinese">写下今天的故事...</h3>
                    <textarea id="diary-text" rows="4" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:outline-none focus:border-sweet-pink" placeholder="今天发生了什么有趣的事呢？"></textarea>
                    
                    <input type="file" id="diary-image-upload" class="hidden" accept="image/*" onchange="previewImage(event)">
                    
                    <div id="image-preview-container" class="hidden mt-4 text-center">
                        <img id="image-preview" src="" alt="图片预览" class="max-h-40 mx-auto rounded-lg">
                        <button onclick="removeImage()" class="mt-2 text-red-500 text-sm">删除图片</button>
                    </div>

                    <div class="flex justify-between items-center mt-4">
                        <button onclick="triggerFileUpload()" title="添加图片" class="bg-sweet-pink text-white w-12 h-12 flex items-center justify-center rounded-full hover:bg-opacity-80 transition transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                        </button>
                        <button id="publish-btn" onclick="addDiaryEntry()" class="bg-sweet-blue text-white py-3 px-8 rounded-xl font-bold hover:bg-opacity-80 transition-all duration-300 transform hover:scale-105">发布日记</button>
                    </div>
                </div>

                <div id="diary-entries" class="space-y-6"></div>
            </section>
        </div>
    </main>
    
    <!-- 通用消息弹窗 -->
    <div id="message-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-bg transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-11/12 max-w-sm">
            <p id="message-modal-text" class="text-gray-700 mb-6 text-lg"></p>
            <div id="message-modal-buttons" class="flex gap-4 justify-center"></div>
        </div>
    </div>

    <script>
    window.addEventListener('DOMContentLoaded', function() {
        // --- LeanCloud 集成 ---
        const APP_ID = "yTrfbPzoiL7ULr4D1iAOoDFn-gzGzoHsz";
        const APP_KEY = "XkqnzXsCOCRDoUTyTUNvt9sa";
        const SERVER_URL = "https://ytrfbpzo.lc-cn-n1-shared.com";

        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
        });

        // --- 全局变量和 DOM 元素 ---
        let currentUser = null;
        let selectedFile = null;
        let confirmCallback = null;
        let diaryLiveQuery;
        let settingsLiveQuery;

        const mainContent = document.getElementById('main-content');
        const diaryText = document.getElementById('diary-text');
        const diaryImageUpload = document.getElementById('diary-image-upload');
        const diaryEntriesContainer = document.getElementById('diary-entries');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const publishBtn = document.getElementById('publish-btn');
        const messageModal = document.getElementById('message-modal');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalButtons = document.getElementById('message-modal-buttons');
        
        // --- 认证与初始化 ---
        async function connectToCloud() {
            try {
                const user = AV.User.current();
                if (!user) {
                    await AV.User.loginAnonymously();
                    console.log("Authenticated with LeanCloud anonymously.");
                } else {
                    console.log("Already authenticated with LeanCloud.");
                }
                initApp(); // 连接成功后初始化应用
            } catch (error) {
                console.error("LeanCloud connection failed:", error);
                showAlert("无法建立安全的云端连接，请检查网络并刷新页面。");
            }
        }
        
        connectToCloud();

        function selectUser(user) {
            currentUser = user;
            const btnHer = document.getElementById('select-her');
            const btnHim = document.getElementById('select-him');
            if (user === 'her') {
                btnHer.classList.add('selected');
                btnHim.classList.remove('selected');
            } else {
                btnHim.classList.add('selected');
                btnHer.classList.remove('selected');
            }
        }

        function initApp() {
            listenForDiaryUpdates();
            listenForDateUpdates();
        }
        
        async function fetchAndRenderDiaries() {
             const query = new AV.Query('Diary');
             query.descending('createdAt');
             try {
                const results = await query.find();
                const entries = results.map(d => ({
                    id: d.id,
                    ...d.attributes,
                    createdAt: d.createdAt
                }));
                renderDiary(entries);
             } catch(error) {
                 console.error("Failed to fetch diaries:", error);
             }
        }

        async function addDiaryEntry() {
            if (!currentUser) {
                showAlert('要先选择是谁在写日记哦~');
                return;
            }
            const text = diaryText.value.trim();
            if (!text && !selectedFile) {
                showAlert('日记内容和图片至少要有一个哦！');
                return;
            }
            publishBtn.disabled = true;
            publishBtn.textContent = '发布中...';
            publishBtn.classList.add('btn-disabled');

            let imageUrl = null;
            if (selectedFile) {
                 try {
                    const file = new AV.File(selectedFile.name, selectedFile);
                    const savedFile = await file.save();
                    imageUrl = savedFile.url();
                 } catch(error) {
                    console.error('LeanCloud upload failed:', error);
                    showAlert('图片上传时发生错误，请稍后再试。');
                    publishBtn.disabled = false;
                    publishBtn.textContent = '发布日记';
                    publishBtn.classList.remove('btn-disabled');
                    return;
                 }
            }
            
            try {
                const Diary = AV.Object.extend('Diary');
                const diary = new Diary();
                diary.set('text', text);
                diary.set('imageUrl', imageUrl);
                diary.set('author', currentUser);
                await diary.save();
                diaryText.value = '';
                removeImage();
            } catch (error) {
                console.error("Error adding document: ", error);
                showAlert('发布日记失败，请检查网络连接。');
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = '发布日记';
                publishBtn.classList.remove('btn-disabled');
            }
        }

        async function listenForDiaryUpdates() {
            if (diaryLiveQuery) await diaryLiveQuery.unsubscribe();
            const query = new AV.Query('Diary');
            try {
                diaryLiveQuery = await query.subscribe();
            } catch(e) {
                console.error("Failed to subscribe to diaries:", e);
                return;
            }
            
            diaryLiveQuery.on('create', fetchAndRenderDiaries);
            diaryLiveQuery.on('update', fetchAndRenderDiaries);
            diaryLiveQuery.on('delete', fetchAndRenderDiaries);
            
            fetchAndRenderDiaries();
        }
        
        function deleteDiaryEntry(id) {
            showConfirm('真的要删除这篇日记吗？这会从云端永久删除哦！', async () => {
                try {
                    const diary = AV.Object.createWithoutData('Diary', id);
                    await diary.destroy();
                } catch(error) {
                    console.error("Error deleting document: ", error);
                    showAlert("删除失败，请稍后再试。");
                }
            });
        }

        function renderDiary(entries) {
            diaryEntriesContainer.innerHTML = '';
            if (entries.length === 0) {
                diaryEntriesContainer.innerHTML = `<div class="text-center text-gray-400 py-8 font-chinese">还没有日记呢，快来写下第一篇吧！</div>`;
                return;
            }
            entries.forEach(entry => {
                const entryEl = document.createElement('div');
                const isHer = entry.author === 'her';
                const authorInfo = isHer
                    ? { name: '小一二', icon: '👑', borderColor: 'border-sweet-pink' }
                    : { name: '小布布', icon: '🛡️', borderColor: 'border-sweet-blue' };

                entryEl.className = `bg-warm-white p-5 rounded-2xl shadow-md fade-in border-l-4 ${authorInfo.borderColor}`;
                
                const date = new Date(entry.createdAt);
                const timeString = date.toLocaleString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const imageHtml = entry.imageUrl ? `<img src="${entry.imageUrl}" alt="日记图片" class="mt-4 rounded-lg w-full diary-image">` : '';

                entryEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                             <div class="flex items-center gap-2">
                                <span class="text-xl">${authorInfo.icon}</span>
                                <span class="font-bold text-sweet-brown font-chinese text-lg">${authorInfo.name}的日记</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-1 ml-2">${timeString}</p>
                        </div>
                        <button onclick="deleteDiaryEntry('${entry.id}')" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
                    </div>
                    <p class="text-gray-800 mt-4 whitespace-pre-wrap pl-2 text-lg">${entry.text || ''}</p>
                    ${imageHtml}
                `;
                diaryEntriesContainer.appendChild(entryEl);
            });
        }

        function triggerFileUpload() { diaryImageUpload.click(); }
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        function removeImage() {
            selectedFile = null;
            diaryImageUpload.value = '';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
        }

        let loveStartDate;
        let timerInterval;

        function updateTimerUI(dateISO) {
             loveStartDate = dateISO ? new Date(dateISO) : new Date('2023-01-01T00:00:00');
             if (timerInterval) clearInterval(timerInterval);
             const update = () => {
                const now = new Date();
                const diff = now - loveStartDate;
                document.getElementById('days').textContent = Math.floor(diff / 864e5);
                document.getElementById('hours').textContent = String(Math.floor((diff % 864e5) / 36e5)).padStart(2, '0');
                document.getElementById('minutes').textContent = String(Math.floor((diff % 36e5) / 6e4)).padStart(2, '0');
                document.getElementById('seconds').textContent = String(Math.floor((diff % 6e4) / 1e3)).padStart(2, '0');
             };
             update();
             timerInterval = setInterval(update, 1000);
             document.getElementById('start-date-display').textContent = loveStartDate.toLocaleString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        async function listenForDateUpdates() {
            if (settingsLiveQuery) await settingsLiveQuery.unsubscribe();
            const query = new AV.Query('Settings');
            
            try {
                const setting = await query.first();
                updateTimerUI(setting ? setting.get('startDate') : null);
            } catch(error) {
                console.error("Initial date fetch failed:", error);
                updateTimerUI(null);
            }

            try {
                settingsLiveQuery = await query.subscribe();
            } catch(e) {
                 console.error("Failed to subscribe to settings:", e);
                 return;
            }
            settingsLiveQuery.on('update', (setting) => {
                updateTimerUI(setting.get('startDate'));
            });
             settingsLiveQuery.on('create', (setting) => {
                updateTimerUI(setting.get('startDate'));
            });
        }

        async function setLoveStartDate() {
            const dateValue = document.getElementById('love-start-date').value;
            if (dateValue) {
                const newStartDate = new Date(dateValue);
                const query = new AV.Query('Settings');
                try {
                    let setting = await query.first();
                    if (!setting) {
                        const Settings = AV.Object.extend('Settings');
                        setting = new Settings();
                    }
                    setting.set('startDate', newStartDate.toISOString());
                    await setting.save();
                    toggleSetDate();
                } catch (error) {
                    console.error("Error saving start date: ", error);
                    showAlert("保存纪念日失败，请稍后再试。");
                }
            }
        }
        
        function toggleSetDate() { 
            document.getElementById('date-setter').classList.toggle('hidden'); 
        }

        function showAlert(message) {
            messageModalText.textContent = message;
            messageModalButtons.innerHTML = `<button onclick="hideMessageModal()" class="w-full bg-sweet-pink text-white py-2 px-6 rounded-xl hover:bg-opacity-80 transition-colors">好的</button>`;
            messageModal.style.display = 'flex';
        }

        function hideMessageModal() {
            messageModal.style.display = 'none';
        }

        function showConfirm(message, callback) {
            confirmCallback = callback;
            messageModalText.textContent = message;
            messageModalButtons.innerHTML = `
                <button onclick="hideMessageModal()" class="w-1/2 bg-gray-300 text-gray-700 py-2 rounded-xl hover:bg-gray-400 transition-colors">取消</button>
                <button onclick="executeConfirm()" class="w-1/2 bg-sweet-pink text-white py-2 rounded-xl hover:bg-opacity-80 transition-colors">确认</button>
            `;
            messageModal.style.display = 'flex';
        }

        function executeConfirm() {
            if (confirmCallback) {
                confirmCallback();
            }
            hideMessageModal();
            confirmCallback = null;
        }

        window.selectUser = selectUser;
        window.toggleSetDate = toggleSetDate;
        window.setLoveStartDate = setLoveStartDate;
        window.triggerFileUpload = triggerFileUpload;
        window.previewImage = previewImage;
        window.removeImage = removeImage;
        window.addDiaryEntry = addDiaryEntry;
        window.deleteDiaryEntry = deleteDiaryEntry;
        window.hideMessageModal = hideMessageModal;
        window.executeConfirm = executeConfirm;
    });
    </script>
</body>
</html>

