<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êàë‰ª¨ÁöÑÊÅãÁà±Â∞èÂ±ã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ÂºïÂÖ• LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13/dist/av-live-query-min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- ÂºïÂÖ•Êñ∞Â≠ó‰Ωì Inter Âíå‰øùÁïôÁöÑËâ∫ÊúØÂ≠ó‰Ωì ZCOOL KuaiLe -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* a very dark blue */
            -webkit-tap-highlight-color: transparent;
        }
        .font-artistic { font-family: 'ZCOOL+KuaiLe', cursive; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(124, 58, 237, 0.5); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(124, 58, 237, 0.8); }

        .fade-in { animation: fadeIn 0.8s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-glow {
            background-color: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(51, 65, 85, 0.5);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        }

        .btn-disabled { cursor: not-allowed; background-color: #334155; }

        .user-select-btn {
            background-color: transparent;
            color: #94a3b8; /* slate-400 */
            border: 2px solid #334155; /* slate-700 */
        }
        .user-select-btn.selected {
            color: #ffffff;
            border-color: #8b5cf6; /* violet-500 */
            background-color: rgba(139, 92, 246, 0.1);
        }
        
        /* Aurora background animation */
        #aurora-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: -1; background-color: #020617;
        }
        .aurora-shape {
            position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.2;
        }
        .shape1 { width: 500px; height: 500px; background-color: #4f46e5; top: -150px; left: -150px; animation: move-aurora 25s infinite alternate ease-in-out; }
        .shape2 { width: 600px; height: 600px; background-color: #a855f7; bottom: -200px; right: -200px; animation: move-aurora 35s infinite alternate-reverse ease-in-out; }
        .shape3 { width: 400px; height: 400px; background-color: #2563eb; bottom: 50%; right: 40%; animation: move-aurora 30s infinite alternate ease-in-out; }
        @keyframes move-aurora { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(200px, 100px) rotate(70deg); } }
        
        /* Comment drawer animation */
        .comments-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s ease-in-out;
        }
        .comments-wrapper.open {
            grid-template-rows: 1fr;
        }
        .comments-content {
            overflow: hidden;
        }
    </style>
</head>
<body class="text-slate-300 custom-scrollbar">
    
    <div id="aurora-background">
        <div class="aurora-shape shape1"></div>
        <div class="aurora-shape shape2"></div>
        <div class="aurora-shape shape3"></div>
    </div>
    
    <div class="relative min-h-screen w-full px-4 sm:px-6 py-12 sm:py-20">
        <div class="w-full max-w-3xl mx-auto space-y-12">
            
            <!-- Â§¥ÈÉ®Âå∫Âüü -->
            <header class="text-center space-y-4 fade-in">
                <h1 class="text-6xl sm:text-7xl font-artistic text-white">‰∏Ä‰∫åÂ∏ÉÂ∏ÉÁöÑÊÇÑÊÇÑËØù</h1>
                <!-- ÊÅãÁà±ËÆ°Êó∂Âô® -->
                <section id="love-timer" class="text-center p-4 rounded-2xl">
                    <p class="text-sm text-slate-400 mb-2">Êàë‰ª¨Â∑≤ÁªèÁõ∏Áà±‰∫Ü</p>
                    <div id="timer-display" class="flex justify-center items-end space-x-2 md:space-x-3 text-white">
                        <div><span id="days" class="text-3xl md:text-4xl font-bold tracking-tight">0</span><span class="text-xs ml-1 text-slate-400">Â§©</span></div>
                        <div><span id="hours" class="text-3xl md:text-4xl font-bold tracking-tight">00</span><span class="text-xs ml-1 text-slate-400">Êó∂</span></div>
                        <div><span id="minutes" class="text-3xl md:text-4xl font-bold tracking-tight">00</span><span class="text-xs ml-1 text-slate-400">ÂàÜ</span></div>
                        <div><span id="seconds" class="text-3xl md:text-4xl font-bold tracking-tight">00</span><span class="text-xs ml-1 text-slate-400">Áßí</span></div>
                    </div>
                    <div class="mt-3 text-slate-500 text-xs">
                        Âßã‰∫é: <span id="start-date-display">...</span>
                        <button onclick="toggleSetDate()" class="ml-2 bg-slate-700/50 text-slate-300 px-2 py-0.5 rounded-md hover:bg-slate-700 transition text-xs">ËÆæÁΩÆ</button>
                    </div>
                    <div id="date-setter" class="hidden mt-3 space-y-2 max-w-xs mx-auto">
                        <input type="datetime-local" id="love-start-date" class="w-full bg-slate-800 border-slate-600 text-white p-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-violet-500">
                        <button onclick="setLoveStartDate()" class="w-full bg-violet-600 text-white rounded-lg py-1.5 hover:bg-violet-700 transition text-sm">‰øùÂ≠ò</button>
                    </div>
                </section>
            </header>

            <!-- Êó•ËÆ∞ÂèëÂ∏ÉÂå∫ -->
            <section id="publisher-section" class="flex flex-col rounded-[28px] p-2 shadow-sm transition-colors bg-slate-900/70 border border-slate-700/80 backdrop-blur-sm fade-in" style="animation-delay: 0.2s;">
                <div class="text-center py-2">
                    <div class="inline-flex rounded-xl p-1 bg-slate-800/50">
                        <button id="select-her" onclick="selectUser('her')" class="px-6 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 text-sm font-semibold user-select-btn">
                            <span class="text-lg">üëë</span> Â∞è‰∏Ä‰∫å
                        </button>
                        <button id="select-him" onclick="selectUser('him')" class="px-6 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 text-sm font-semibold user-select-btn">
                            <span class="text-lg">üõ°Ô∏è</span> Â∞èÂ∏ÉÂ∏É
                        </button>
                    </div>
                </div>
                <div id="image-preview-container" class="hidden relative mt-1 w-fit rounded-xl px-1 pt-1 ml-2">
                    <img id="image-preview" src="" alt="Image preview" class="h-16 w-16 rounded-lg object-cover">
                    <button onclick="removeImage()" class="absolute right-2 top-2 z-10 flex h-4 w-4 items-center justify-center rounded-full bg-black/50 text-white transition-colors hover:bg-black/80" aria-label="Remove image">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="h-3 w-3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <textarea id="diary-text" rows="1" placeholder="ËØ¥ÁÇπ‰ªÄ‰πàÂêß..." class="custom-scrollbar w-full resize-none border-0 bg-transparent p-3 text-slate-200 placeholder:text-slate-500 focus:ring-0 focus-visible:outline-none min-h-12"></textarea>
                <div class="mt-0.5 p-1 pt-0">
                    <div class="flex items-center gap-2">
                        <input type="file" id="diary-image-upload" class="hidden" accept="image/*" onchange="previewImage(event)">
                        <button type="button" onclick="triggerFileUpload()" class="flex h-8 w-8 items-center justify-center rounded-full text-slate-300 transition-colors hover:bg-slate-700/50 focus-visible:outline-none">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="sr-only">Attach image</span>
                        </button>
                        <div class="ml-auto flex items-center gap-2">
                            <button id="publish-btn" type="submit" disabled class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none bg-white text-black hover:bg-white/80 disabled:bg-slate-600">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5.25L12 18.75" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M18.75 12L12 5.25L5.25 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                <span class="sr-only">Send message</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Êó•ËÆ∞Â±ïÁ§∫Âå∫ -->
            <main id="diary-entries" class="space-y-8"></main>
        </div>
    </div>
    
    <!-- ÈÄöÁî®Ê∂àÊÅØÂºπÁ™ó -->
    <div id="message-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="card-glow p-6 rounded-2xl shadow-2xl text-center w-11/12 max-w-sm">
            <p id="message-modal-text" class="text-slate-200 mb-6 text-base"></p>
            <div id="message-modal-buttons" class="flex gap-4 justify-center"></div>
        </div>
    </div>
    
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        const APP_ID = "yTrfbPzoiL7ULr4D1iAOoDFn-gzGzoHsz", APP_KEY = "XkqnzXsCOCRDoUTyTUNvt9sa", SERVER_URL = "https://ytrfbpzo.lc-cn-n1-shared.com";
        AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });

        let currentUser = null, selectedFile = null, confirmCallback = null;

        const DOMElements = {
            diaryEntriesContainer: document.getElementById('diary-entries'),
            messageModal: document.getElementById('message-modal'),
            messageModalText: document.getElementById('message-modal-text'),
            messageModalButtons: document.getElementById('message-modal-buttons'),
            diaryTextInput: document.getElementById('diary-text'),
            publishBtn: document.getElementById('publish-btn'),
            imagePreviewContainer: document.getElementById('image-preview-container'),
            imagePreview: document.getElementById('image-preview'),
            diaryImageUpload: document.getElementById('diary-image-upload'),
        };
        
        function selectUser(user) {
            currentUser = user;
            document.querySelectorAll('.user-select-btn').forEach(btn => btn.classList.remove('selected'));
            if (user === 'her') document.getElementById('select-her').classList.add('selected');
            else document.getElementById('select-him').classList.add('selected');
        }

        function toggleComments(diaryId) {
            const commentsWrapper = document.getElementById(`comments-section-${diaryId}`);
            commentsWrapper.classList.toggle('open');
        }

        async function renderDiaryEntries(entries) {
            DOMElements.diaryEntriesContainer.innerHTML = '';
            if (entries.length === 0) {
                DOMElements.diaryEntriesContainer.innerHTML = `<div class="text-center text-slate-500 py-8">ËøòÊ≤°ÊúâÊó•ËÆ∞Âë¢ÔºåÂø´Êù•ÂÜô‰∏ãÁ¨¨‰∏ÄÁØáÂêßÔºÅ</div>`;
                return;
            }

            for (const entry of entries) {
                const entryEl = document.createElement('article');
                entryEl.className = 'card-glow rounded-3xl fade-in shadow-lg shadow-violet-900/20';
                
                const isHer = entry.author === 'her';
                const authorInfo = isHer ? { name: 'Â∞è‰∏Ä‰∫å', icon: 'üëë' } : { name: 'Â∞èÂ∏ÉÂ∏É', icon: 'üõ°Ô∏è' };
                const date = new Date(entry.createdAt);
                const timeString = date.toLocaleString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const imageUrl = entry.imageUrl ? entry.imageUrl.get('url') : null;

                entryEl.innerHTML = `
                    <div class="p-8">
                        ${imageUrl ? `<img src="${imageUrl}" alt="Êó•ËÆ∞ÂõæÁâá" class="w-full rounded-xl mb-6 max-h-[60vh] object-contain">` : ''}
                        <p class="text-slate-300 whitespace-pre-wrap leading-relaxed mb-8">${entry.text || ''}</p>
                    
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-x-3">
                                <div class="size-10 rounded-full bg-slate-700/50 flex items-center justify-center text-2xl">${authorInfo.icon}</div>
                                <div>
                                    <p class="font-semibold text-white">${authorInfo.name}</p>
                                    <p class="text-xs text-slate-400">${timeString}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-x-4">
                                <button onclick="toggleComments('${entry.id}')" class="text-slate-400 hover:text-white transition flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                    <span id="comment-count-${entry.id}" class="text-xs font-mono"></span>
                                </button>
                                <button onclick="deleteDiaryEntry('${entry.id}')" class="text-slate-500 hover:text-red-500 text-xl font-bold">&times;</button>
                            </div>
                        </div>
                        <div id="comments-section-${entry.id}" class="comments-wrapper">
                            <div class="comments-content mt-6 pt-6 border-t border-slate-700/50">
                                <div id="comments-for-${entry.id}" class="space-y-3 mb-4 max-h-48 overflow-y-auto custom-scrollbar pr-2"></div>
                                <div class="flex items-center gap-2">
                                    <input id="comment-input-${entry.id}" type="text" placeholder="ËØ¥ÁÇπ‰ªÄ‰πàÂêß..." class="bg-slate-800/50 border-slate-700 w-full text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-violet-500">
                                    <button onclick="addComment('${entry.id}')" class="bg-violet-600/80 text-white text-sm rounded-lg px-3 py-1.5 hover:bg-violet-600 transition flex-shrink-0">ÂèëÈÄÅ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                DOMElements.diaryEntriesContainer.appendChild(entryEl);
                await fetchAndRenderComments(entry.id);
            }
        }
        
        async function fetchAndRenderComments(diaryId) {
            const container = document.getElementById(`comments-for-${diaryId}`); if (!container) return;
            const query = new AV.Query('Comment');
            query.equalTo('diary', AV.Object.createWithoutData('Diary', diaryId));
            query.ascending('createdAt');
            try {
                const comments = await query.find();
                const countContainer = document.getElementById(`comment-count-${diaryId}`);
                if (countContainer) {
                    if (comments.length > 0) {
                        countContainer.textContent = comments.length;
                    } else {
                        countContainer.textContent = '';
                    }
                }
                container.innerHTML = comments.map(comment => {
                    const author = comment.get('author'), text = comment.get('text'), isHer = author === 'her';
                    const authorInfo = isHer ? { name: 'Â∞è‰∏Ä‰∫å', icon: 'üëë'} : { name: 'Â∞èÂ∏ÉÂ∏É', icon: 'üõ°Ô∏è'};
                    const date = new Date(comment.get('createdAt'));
                    const timeString = date.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="flex items-start gap-2 group text-sm">
                            <span class="text-lg mt-0.5">${authorInfo.icon}</span>
                            <div class="bg-slate-700/50 rounded-lg px-3 py-1.5 flex-grow">
                                <div class="flex justify-between items-start">
                                  <div><span class="font-bold text-white">${authorInfo.name}:</span> <span class="text-slate-300">${text}</span></div>
                                  <button onclick="deleteComment('${comment.id}', '${diaryId}')" class="text-slate-600 hover:text-red-500 font-bold opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0 ml-2">&times;</button>
                                </div>
                                <div class="text-right text-xs text-slate-500 mt-1">${timeString}</div>
                            </div>
                        </div>`;
                }).join('');
            } catch (error) { console.error(`Failed to fetch comments for ${diaryId}:`, error); }
        }

        async function listenForUpdates() {
             try {
                const diaryQuery = new AV.Query('Diary');
                const diaryLiveQuery = await diaryQuery.subscribe();
                const fullRender = async () => { const entries = await new AV.Query('Diary').descending('createdAt').include('imageUrl').find(); renderDiaryEntries(entries.map(d => ({ id: d.id, ...d.attributes, createdAt: d.createdAt }))); };
                diaryLiveQuery.on('create', fullRender);
                diaryLiveQuery.on('update', fullRender);
                diaryLiveQuery.on('delete', fullRender);

                const commentQuery = new AV.Query('Comment');
                const commentLiveQuery = await commentQuery.subscribe();
                commentLiveQuery.on('create', (comment) => { const diaryPointer = comment.get('diary'); if (diaryPointer) fetchAndRenderComments(diaryPointer.id); });
                commentLiveQuery.on('delete', (comment) => { const diaryPointer = comment.get('diary'); if (diaryPointer) fetchAndRenderComments(diaryPointer.id); });

                const settingsQuery = new AV.Query('Settings');
                const setting = await settingsQuery.first();
                updateTimerUI(setting ? setting.get('startDate') : null);
                const settingsLiveQuery = await settingsQuery.subscribe();
                settingsLiveQuery.on('update', (s) => updateTimerUI(s.get('startDate')));
                settingsLiveQuery.on('create', (s) => updateTimerUI(s.get('startDate')));
            } catch(e) { console.error("LiveQuery Subscription failed:", e); }
        }
        
        async function initApp() {
            const query = new AV.Query('Diary');
            query.descending('createdAt');
            query.include('imageUrl');
            const results = await query.find();
            const entries = results.map(d => ({ id: d.id, ...d.attributes, createdAt: d.createdAt }));
            await renderDiaryEntries(entries);
            await listenForUpdates();
        }
        
        const showAlert = function(message) { DOMElements.messageModalText.textContent = message; DOMElements.messageModalButtons.innerHTML = `<button onclick="this.parentElement.parentElement.parentElement.style.display='none'" class="w-full bg-violet-600 text-white py-2 px-6 rounded-lg hover:bg-violet-700 transition-colors text-sm">Â•ΩÁöÑ</button>`; DOMElements.messageModal.style.display = 'flex'; };
        const showConfirm = function(message, callback) { confirmCallback = callback; DOMElements.messageModalText.textContent = message; DOMElements.messageModalButtons.innerHTML = `<button onclick="this.parentElement.parentElement.parentElement.style.display='none'" class="w-1/2 bg-slate-600 text-slate-200 py-2 rounded-lg hover:bg-slate-500 transition-colors text-sm">ÂèñÊ∂à</button><button id="confirm-execute-btn" class="w-1/2 bg-violet-600 text-white py-2 rounded-lg hover:bg-violet-700 transition-colors text-sm">Á°ÆËÆ§</button>`; DOMElements.messageModal.style.display = 'flex'; document.getElementById('confirm-execute-btn').onclick = () => { if (confirmCallback) { confirmCallback(); DOMElements.messageModal.style.display = 'none'; confirmCallback = null; } };};
        
        const updatePublishButtonState = function() {
            const hasValue = DOMElements.diaryTextInput.value.trim().length > 0 || selectedFile;
            DOMElements.publishBtn.disabled = !hasValue;
        };

        const removeImage = function() { selectedFile = null; DOMElements.diaryImageUpload.value = ''; DOMElements.imagePreview.src = ''; DOMElements.imagePreviewContainer.classList.add('hidden'); updatePublishButtonState();};
        
        const addDiaryEntry = async function() { if (!currentUser) return showAlert('Ë¶ÅÂÖàÈÄâÊã©ÊòØË∞ÅÂú®ÂÜôÊó•ËÆ∞Âì¶~'); const text = DOMElements.diaryTextInput.value.trim(); if (!text && !selectedFile) return showAlert('Êó•ËÆ∞ÂÜÖÂÆπÂíåÂõæÁâáËá≥Â∞ëË¶ÅÊúâ‰∏Ä‰∏™Âì¶ÔºÅ'); DOMElements.publishBtn.disabled = true; try { const Diary = AV.Object.extend('Diary'); const diary = new Diary(); diary.set('text', text); diary.set('author', currentUser); if (selectedFile) { const imageFile = new AV.File(selectedFile.name, selectedFile); diary.set('imageUrl', imageFile); } await diary.save(); DOMElements.diaryTextInput.value = ''; DOMElements.diaryTextInput.style.height = 'auto'; removeImage(); } catch (error) { showAlert(`ÂèëÂ∏ÉÊó•ËÆ∞Â§±Ë¥•: ${error.message}`); } finally { DOMElements.publishBtn.disabled = false; updatePublishButtonState(); } };
        
        const addComment = async function(diaryId) { if (!currentUser) return showAlert('Ë¶ÅÂÖàÈÄâÊã©ÊòØË∞ÅÂú®ÁïôË®ÄÂì¶~'); const inputEl = document.getElementById(`comment-input-${diaryId}`); const text = inputEl.value.trim(); if (!text) return; try { const Comment = AV.Object.extend('Comment'); const comment = new Comment(); comment.set('text', text); comment.set('author', currentUser); comment.set('diary', AV.Object.createWithoutData('Diary', diaryId)); await comment.save(); inputEl.value = ''; } catch (error) { showAlert('ÁïôË®ÄÂ§±Ë¥•‰∫ÜÔºåËØ∑Á®çÂêéÂÜçËØï~'); } };
        const deleteDiaryEntry = function(id) { showConfirm('ÁúüÁöÑË¶ÅÂà†Èô§ËøôÁØáÊó•ËÆ∞ÂêóÔºü', async () => { try { await AV.Object.createWithoutData('Diary', id).destroy(); } catch(error) { showAlert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ"); } }); };
        const deleteComment = function(id, diaryId) { showConfirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÁïôË®ÄÂêóÔºü', async () => { try { await AV.Object.createWithoutData('Comment', id).destroy(); fetchAndRenderComments(diaryId); } catch(error) { showAlert("Âà†Èô§ÁïôË®ÄÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ"); } }); };
        let loveStartDate, timerInterval; const updateTimerUI = function(dateISO) { loveStartDate = dateISO ? new Date(dateISO) : new Date('2023-01-01T00:00:00'); if (timerInterval) clearInterval(timerInterval); const update = () => { const now = new Date(); const diff = now - loveStartDate; document.getElementById('days').textContent = Math.floor(diff / 864e5); document.getElementById('hours').textContent = String(Math.floor((diff % 864e5) / 36e5)).padStart(2, '0'); document.getElementById('minutes').textContent = String(Math.floor((diff % 36e5) / 6e4)).padStart(2, '0'); document.getElementById('seconds').textContent = String(Math.floor((diff % 6e4) / 1e3)).padStart(2, '0'); }; update(); timerInterval = setInterval(update, 1000); document.getElementById('start-date-display').textContent = loveStartDate.toLocaleString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }); };
        const toggleSetDate = function() { document.getElementById('date-setter').classList.toggle('hidden'); };
        const setLoveStartDate = async function() { const dateValue = document.getElementById('love-start-date').value; if (dateValue) { const newStartDate = new Date(dateValue); const query = new AV.Query('Settings'); try { let setting = await query.first(); if (!setting) { const Settings = AV.Object.extend('Settings'); setting = new Settings(); } setting.set('startDate', newStartDate.toISOString()); await setting.save(); toggleSetDate(); } catch (error) { showAlert("‰øùÂ≠òÁ∫™ÂøµÊó•Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ"); } } };
        const triggerFileUpload = function() { DOMElements.diaryImageUpload.click(); };
        const previewImage = function(event) { const file = event.target.files[0]; if (!file) return; selectedFile = file; const reader = new FileReader(); reader.onload = (e) => { DOMElements.imagePreview.src = e.target.result; DOMElements.imagePreviewContainer.classList.remove('hidden'); }; reader.readAsDataURL(file); updatePublishButtonState(); };
        const connectToCloud = async function() { try { if (!AV.User.current()) await AV.User.loginAnonymously(); initApp(); } catch (error) { showAlert("Êó†Ê≥ïÂª∫Á´ãÂÆâÂÖ®ÁöÑ‰∫ëÁ´ØËøûÊé•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂπ∂Âà∑Êñ∞È°µÈù¢„ÄÇ"); } };

        Object.assign(window, {
            selectUser, toggleComments,
            addDiaryEntry, addComment, deleteDiaryEntry, deleteComment,
            triggerFileUpload, previewImage, removeImage,
            toggleSetDate, setLoveStartDate
        });
        
        DOMElements.diaryTextInput.addEventListener('input', () => {
            const textarea = DOMElements.diaryTextInput;
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 200); // Max height 200px
            textarea.style.height = `${newHeight}px`;
            updatePublishButtonState();
        });

        DOMElements.publishBtn.onclick = addDiaryEntry;

        connectToCloud();
    });
    </script>
</body>
</html>

