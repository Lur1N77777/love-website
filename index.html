<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘ä»¬çš„æ‹çˆ±å°å±‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13/dist/av-live-query-min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- å¯çˆ±å­—ä½“ ZCOOL KuaiLe -->
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Gaegu', cursive; background-color: #faeee7; -webkit-tap-highlight-color: transparent; }
        .font-artistic { font-family: 'ZCOOL KuaiLe', cursive; }
        .text-headline { color: #33272a; }
        .text-paragraph { color: #594a4e; }
        .bg-button { background-color: #ff8ba7; }
        .text-button { color: #33272a; }
        .bg-card { background-color: #fffffe; }
        .border-highlight { border-color: #ff8ba7; }
        .bg-secondary { background-color: #ffc6c7; }
        .bg-glass-effect {
            background-color: rgba(255, 255, 254, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(236, 72, 153, 0.15);
        }
        .fade-in { animation: fadeIn 1s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-bg { background-color: rgba(0, 0, 0, 0.5); }
        .diary-image { max-height: 300px; object-fit: cover; }
        .btn-disabled { cursor: not-allowed; background-color: #d1d5db; }
        .user-select-btn {
            background-color: #fffffe;
            color: #594a4e;
            font-size: 1.1rem;
            font-weight: bold;
            border: 2px solid transparent;
        }
        .user-select-btn.selected {
            border-color: #ff8ba7;
            color: #33272a;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .comment-input {
            border: 2px solid #ffc6c7;
            font-family: 'Gaegu', cursive;
            transition: all 0.3s;
        }
        .comment-input:focus {
            border-color: #ff8ba7;
            box-shadow: 0 0 0 3px rgba(255, 139, 167, 0.4);
        }
        .comment-input::placeholder { color: #b2a19b; }
        #month-nav button {
            background-color: rgba(255, 255, 254, 0.8);
            backdrop-filter: blur(5px);
        }
        .text-shadow-custom { text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- ä¸»å†…å®¹åŒº -->
    <main id="main-content" class="w-full max-w-4xl mx-auto">
        <div class="bg-glass-effect rounded-3xl p-6 md:p-10 space-y-8 fade-in">
            <!-- å¤´éƒ¨ -->
            <header class="text-center">
                <h1 class="text-5xl md:text-6xl font-artistic text-headline">æˆ‘ä»¬çš„æ‹çˆ±å°å±‹</h1>
                <p class="text-paragraph mt-2 text-lg">è®°å½•æˆ‘ä»¬åœ¨ä¸€èµ·çš„æ¯åˆ†æ¯ç§’</p>
            </header>
            
            <!-- ç”¨æˆ·é€‰æ‹©å™¨ -->
            <section id="user-selector" class="text-center">
                <h3 class="font-bold text-lg mb-4 text-headline font-artistic text-3xl">ä»Šå¤©æ˜¯è°åœ¨è®°å½•å‘€ï¼Ÿ</h3>
                <div class="inline-flex rounded-xl shadow-sm">
                    <button id="select-her" onclick="selectUser('her')" class="user-select-btn px-6 py-3 rounded-l-xl transition-all duration-300">
                        <span class="text-xl mr-2">ğŸ‘‘</span> å°ä¸€äºŒ
                    </button>
                    <button id="select-him" onclick="selectUser('him')" class="user-select-btn px-6 py-3 rounded-r-xl transition-all duration-300">
                        <span class="text-xl mr-2">ğŸ›¡ï¸</span> å°å¸ƒå¸ƒ
                    </button>
                </div>
            </section>

            <!-- æ‹çˆ±è®¡æ—¶å™¨ -->
            <section id="love-timer" class="text-center bg-secondary rounded-2xl p-6 shadow-sm">
                 <h2 class="text-3xl font-artistic text-headline mb-4">æˆ‘ä»¬å·²ç»ç›¸çˆ±äº†</h2>
                <div id="timer-display" class="flex justify-center items-center space-x-2 md:space-x-4 text-headline">
                    <div class="text-center"><span id="days" class="text-4xl md:text-6xl font-bold text-shadow-custom">0</span><p>å¤©</p></div>
                    <div class="text-4xl md:text-6xl font-bold text-shadow-custom">:</div>
                    <div class="text-center"><span id="hours" class="text-4xl md:text-6xl font-bold text-shadow-custom">0</span><p>æ—¶</p></div>
                    <div class="text-4xl md:text-6xl font-bold text-shadow-custom">:</div>
                    <div class="text-center"><span id="minutes" class="text-4xl md:text-6xl font-bold text-shadow-custom">0</span><p>åˆ†</p></div>
                    <div class="text-4xl md:text-6xl font-bold text-shadow-custom">:</div>
                    <div class="text-center"><span id="seconds" class="text-4xl md:text-6xl font-bold text-shadow-custom">0</span><p>ç§’</p></div>
                </div>
                <div class="mt-4 text-paragraph font-bold">
                    å§‹äº: <span id="start-date-display">...</span>
                </div>
                <button onclick="toggleSetDate()" class="mt-4 bg-card text-paragraph px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50 transition">è®¾ç½®/ä¿®æ”¹çºªå¿µæ—¥</button>
                <div id="date-setter" class="hidden mt-4 space-y-2 max-w-sm mx-auto">
                    <input type="datetime-local" id="love-start-date" class="w-full border-2 border-gray-200 p-2 rounded-lg focus:outline-none focus:border-highlight">
                    <button onclick="setLoveStartDate()" class="w-full bg-button text-button rounded-lg py-2 hover:bg-opacity-90 transition">ä¿å­˜</button>
                </div>
            </section>

            <!-- æ‹çˆ±æ—¥è®° -->
            <section id="love-diary">
                <h2 class="text-4xl font-artistic text-headline text-center mb-6">æˆ‘ä»¬çš„ç”œèœœæ—¥è®°</h2>
                <div class="bg-card p-6 rounded-2xl shadow-md mb-8">
                    <h3 class="font-bold text-lg mb-4 text-headline font-artistic text-3xl">å†™ä¸‹ä»Šå¤©çš„æ•…äº‹...</h3>
                    <textarea id="diary-text" rows="4" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:outline-none focus:border-highlight" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆæœ‰è¶£çš„äº‹å‘¢ï¼Ÿ"></textarea>
                    <input type="file" id="diary-image-upload" class="hidden" accept="image/*" onchange="previewImage(event)">
                    <div id="image-preview-container" class="hidden mt-4 text-center">
                        <img id="image-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ" class="max-h-40 mx-auto rounded-lg">
                        <button onclick="removeImage()" class="mt-2 text-red-500 text-sm">åˆ é™¤å›¾ç‰‡</button>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <button onclick="triggerFileUpload()" title="æ·»åŠ å›¾ç‰‡" class="bg-button text-white w-12 h-12 flex items-center justify-center rounded-full hover:bg-opacity-90 transition transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                        </button>
                        <button id="publish-btn" onclick="addDiaryEntry()" class="bg-button text-button py-3 px-8 rounded-xl font-bold hover:bg-opacity-90 transition-all duration-300 transform hover:scale-105">å‘å¸ƒæ—¥è®°</button>
                    </div>
                </div>
                <div id="month-nav" class="sticky top-4 z-10 text-center mb-6 transition-opacity duration-300 opacity-0"></div>
                <div id="diary-entries" class="space-y-6"></div>
            </section>
        </div>
    </main>
    
    <!-- é€šç”¨æ¶ˆæ¯å¼¹çª— -->
    <div id="message-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-bg">
        <div class="bg-card p-6 rounded-2xl shadow-2xl text-center w-11/12 max-w-sm">
            <p id="message-modal-text" class="text-paragraph mb-6 text-lg"></p>
            <div id="message-modal-buttons" class="flex gap-4 justify-center"></div>
        </div>
    </div>

    <script>
    window.addEventListener('DOMContentLoaded', function() {
        // --- LeanCloud é›†æˆ ---
        const APP_ID = "yTrfbPzoiL7ULr4D1iAOoDFn-gzGzoHsz";
        const APP_KEY = "XkqnzXsCOCRDoUTyTUNvt9sa";
        const SERVER_URL = "https://ytrfbpzo.lc-cn-n1-shared.com";

        AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });

        // --- å…¨å±€å˜é‡ ---
        let currentUser = null, selectedFile = null, confirmCallback = null;
        let diaryLiveQuery, settingsLiveQuery, commentLiveQuery;

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const DOMElements = {
            diaryText: document.getElementById('diary-text'),
            diaryImageUpload: document.getElementById('diary-image-upload'),
            diaryEntriesContainer: document.getElementById('diary-entries'),
            imagePreviewContainer: document.getElementById('image-preview-container'),
            imagePreview: document.getElementById('image-preview'),
            publishBtn: document.getElementById('publish-btn'),
            messageModal: document.getElementById('message-modal'),
            messageModalText: document.getElementById('message-modal-text'),
            messageModalButtons: document.getElementById('message-modal-buttons'),
            monthNavContainer: document.getElementById('month-nav'),
        };
        
        // --- å‡½æ•°å®šä¹‰åŒº (æå‰å®šä¹‰æ‰€æœ‰å‡½æ•°) ---
        
        function showAlert(message) {
            DOMElements.messageModalText.textContent = message;
            DOMElements.messageModalButtons.innerHTML = `<button onclick="hideMessageModal()" class="w-full bg-button text-button py-2 px-6 rounded-xl hover:bg-opacity-90 transition-colors">å¥½çš„</button>`;
            DOMElements.messageModal.style.display = 'flex';
        }

        function hideMessageModal() { DOMElements.messageModal.style.display = 'none'; }

        function showConfirm(message, callback) {
            confirmCallback = callback;
            DOMElements.messageModalText.textContent = message;
            DOMElements.messageModalButtons.innerHTML = `
                <button onclick="hideMessageModal()" class="w-1/2 bg-gray-200 text-gray-700 py-2 rounded-xl hover:bg-gray-300 transition-colors">å–æ¶ˆ</button>
                <button onclick="executeConfirm()" class="w-1/2 bg-button text-button py-2 rounded-xl hover:bg-opacity-90 transition-colors">ç¡®è®¤</button>
            `;
            DOMElements.messageModal.style.display = 'flex';
        }

        function executeConfirm() {
            if (confirmCallback) confirmCallback();
            hideMessageModal();
            confirmCallback = null;
        }
        
        function selectUser(user) {
            currentUser = user;
            document.getElementById('select-her').classList.toggle('selected', user === 'her');
            document.getElementById('select-him').classList.toggle('selected', user === 'him');
        }

        function scrollToMonth(month) {
            const firstEntryOfMonth = document.querySelector(`.diary-entry[data-month="${month}"]`);
            if (firstEntryOfMonth) {
                firstEntryOfMonth.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function renderMonthNav(entries) {
            if (entries.length < 5) {
                DOMElements.monthNavContainer.innerHTML = '';
                DOMElements.monthNavContainer.classList.add('opacity-0');
                return;
            }
            const months = [...new Set(entries.map(entry => {
                const date = new Date(entry.createdAt);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }))];
            DOMElements.monthNavContainer.innerHTML = months.map(month => 
                `<button onclick="scrollToMonth('${month}')" class="px-3 py-1 text-sm text-paragraph rounded-full shadow-sm hover:bg-secondary hover:text-headline transition-colors mx-1">${month}</button>`
            ).join('');
            DOMElements.monthNavContainer.classList.remove('opacity-0');
        }
        
        async function fetchAndRenderDiaries() {
             const query = new AV.Query('Diary');
             query.descending('createdAt');
             query.include('imageUrl');
             try {
                const results = await query.find();
                const entries = results.map(d => ({ id: d.id, ...d.attributes, createdAt: d.createdAt }));
                renderMonthNav(entries);
                await renderDiary(entries);
             } catch(error) {
                 console.error("Failed to fetch diaries:", error);
             }
        }
        
        async function fetchAndRenderComments(diaryId) {
            const container = document.getElementById(`comments-for-${diaryId}`);
            if (!container) return;
            const query = new AV.Query('Comment');
            query.equalTo('diary', AV.Object.createWithoutData('Diary', diaryId));
            query.ascending('createdAt');
            try {
                const comments = await query.find();
                container.innerHTML = '';
                comments.forEach(comment => {
                    const author = comment.get('author');
                    const text = comment.get('text');
                    const isHer = author === 'her';
                    const authorInfo = isHer ? { name: 'å°ä¸€äºŒ', icon: 'ğŸ‘‘'} : { name: 'å°å¸ƒå¸ƒ', icon: 'ğŸ›¡ï¸'};
                    const date = new Date(comment.get('createdAt'));
                    const timeString = date.toLocaleString('zh-CN', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const commentEl = document.createElement('div');
                    commentEl.className = 'flex items-start gap-2 mt-2 group';
                    commentEl.innerHTML = `
                        <span class="text-lg">${authorInfo.icon}</span>
                        <div class="bg-gray-100 rounded-lg px-3 py-1 text-sm flex-grow">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-bold text-headline">${authorInfo.name}:</span>
                                    <span class="text-paragraph">${text}</span>
                                </div>
                                <button onclick="deleteComment('${comment.id}')" class="text-gray-300 hover:text-red-500 text-xl font-bold opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${timeString}</p>
                        </div>
                    `;
                    container.appendChild(commentEl);
                });
            } catch (error) { console.error(`Failed to fetch comments for ${diaryId}:`, error); }
        }
        
        async function addDiaryEntry() {
            if (!currentUser) return showAlert('è¦å…ˆé€‰æ‹©æ˜¯è°åœ¨å†™æ—¥è®°å“¦~');
            const text = DOMElements.diaryText.value.trim();
            if (!text && !selectedFile) return showAlert('æ—¥è®°å†…å®¹å’Œå›¾ç‰‡è‡³å°‘è¦æœ‰ä¸€ä¸ªå“¦ï¼');
            
            DOMElements.publishBtn.disabled = true;
            DOMElements.publishBtn.textContent = 'å‘å¸ƒä¸­...';
            DOMElements.publishBtn.classList.add('btn-disabled');

            try {
                const Diary = AV.Object.extend('Diary');
                const diary = new Diary();
                
                let savedImageFile = null;
                if (selectedFile) {
                    DOMElements.publishBtn.textContent = 'å›¾ç‰‡ä¸Šä¼ ä¸­...';
                    // å…ˆåˆ›å»ºå¹¶ä¿å­˜æ–‡ä»¶
                    const imageFile = new AV.File(selectedFile.name, selectedFile);
                    savedImageFile = await imageFile.save();
                }
                
                DOMElements.publishBtn.textContent = 'ä¿å­˜æ—¥è®°ä¸­...';
                diary.set('text', text);
                diary.set('author', currentUser);
                if (savedImageFile) {
                    // ä½¿ç”¨å·²ä¿å­˜çš„æ–‡ä»¶å¯¹è±¡è¿›è¡Œå…³è”
                    diary.set('imageUrl', savedImageFile);
                }
                await diary.save();
                
                DOMElements.diaryText.value = '';
                removeImage();
            } catch (error) {
                console.error("Error adding document: ", error);
                showAlert(`å‘å¸ƒæ—¥è®°å¤±è´¥: ${error.message}`);
            } finally {
                DOMElements.publishBtn.disabled = false;
                DOMElements.publishBtn.textContent = 'å‘å¸ƒæ—¥è®°';
                DOMElements.publishBtn.classList.remove('btn-disabled');
            }
        }
        
        async function addComment(diaryId) {
            if (!currentUser) return showAlert('è¦å…ˆé€‰æ‹©æ˜¯è°åœ¨ç•™è¨€å“¦~');
            const inputEl = document.getElementById(`comment-input-${diaryId}`);
            const text = inputEl.value.trim();
            if (!text) return;
            try {
                const Comment = AV.Object.extend('Comment');
                const comment = new Comment();
                comment.set('text', text);
                comment.set('author', currentUser);
                comment.set('diary', AV.Object.createWithoutData('Diary', diaryId));
                await comment.save();
                inputEl.value = '';
            } catch (error) {
                console.error('Error adding comment:', error);
                showAlert('ç•™è¨€å¤±è´¥äº†ï¼Œè¯·ç¨åå†è¯•~');
            }
        }

        async function listenForUpdates() {
            const diaryQuery = new AV.Query('Diary');
            const commentQuery = new AV.Query('Comment');
            
            try {
                diaryLiveQuery = await diaryQuery.subscribe();
                diaryLiveQuery.on('create', fetchAndRenderDiaries);
                diaryLiveQuery.on('update', fetchAndRenderDiaries);
                diaryLiveQuery.on('delete', fetchAndRenderDiaries);

                commentLiveQuery = await commentQuery.subscribe();
                commentLiveQuery.on('create', (comment) => {
                    const diaryPointer = comment.get('diary');
                    if (diaryPointer) fetchAndRenderComments(diaryPointer.id);
                });
                commentLiveQuery.on('delete', (comment) => {
                    const diaryPointer = comment.get('diary');
                     if (diaryPointer) fetchAndRenderComments(diaryPointer.id);
                });
            } catch(e) {
                console.error("LiveQuery Subscription failed:", e);
            }
            
            fetchAndRenderDiaries();
            listenForDateUpdates();
        }
        
        async function deleteDiaryEntry(id) {
            showConfirm('çœŸçš„è¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿè¿™ä¼šä»äº‘ç«¯æ°¸ä¹…åˆ é™¤å“¦ï¼', async () => {
                try {
                    const diary = AV.Object.createWithoutData('Diary', id);
                    await diary.destroy();
                } catch(error) { showAlert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            });
        }
        
        async function deleteComment(id) {
            showConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ', async () => {
                 try {
                    const comment = AV.Object.createWithoutData('Comment', id);
                    await comment.destroy();
                } catch(error) { showAlert("åˆ é™¤ç•™è¨€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            });
        }

        async function renderDiary(entries) {
            DOMElements.diaryEntriesContainer.innerHTML = '';
            if (entries.length === 0) {
                 DOMElements.diaryEntriesContainer.innerHTML = `<div class="text-center text-paragraph py-8 font-artistic text-xl">è¿˜æ²¡æœ‰æ—¥è®°å‘¢ï¼Œå¿«æ¥å†™ä¸‹ç¬¬ä¸€ç¯‡å§ï¼</div>`;
                return;
            }
            for (const entry of entries) {
                const entryEl = document.createElement('div');
                const isHer = entry.author === 'her';
                const authorInfo = isHer
                    ? { name: 'å°ä¸€äºŒ', icon: 'ğŸ‘‘', borderColor: 'border-highlight' }
                    : { name: 'å°å¸ƒå¸ƒ', icon: 'ğŸ›¡ï¸', borderColor: 'border-blue-300' };
                
                const date = new Date(entry.createdAt);
                const monthString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                entryEl.className = `diary-entry bg-card p-5 rounded-2xl shadow-md fade-in border-l-4 ${authorInfo.borderColor}`;
                entryEl.setAttribute('data-month', monthString);
                
                const timeString = date.toLocaleString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                const imageObject = entry.imageUrl;
                const imageUrl = imageObject ? imageObject.get('url') : null;
                const imageHtml = imageUrl ? `<img src="${imageUrl}" alt="æ—¥è®°å›¾ç‰‡" class="mt-4 rounded-lg w-full diary-image">` : '';

                entryEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                             <div class="flex items-center gap-2">
                                <span class="text-xl">${authorInfo.icon}</span>
                                <span class="font-bold text-headline font-artistic text-3xl">${authorInfo.name}çš„æ—¥è®°</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-1 ml-2">${timeString}</p>
                        </div>
                        <button onclick="deleteDiaryEntry('${entry.id}')" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
                    </div>
                    <p class="text-paragraph mt-4 whitespace-pre-wrap pl-2 text-lg">${entry.text || ''}</p>
                    ${imageHtml}
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div id="comments-for-${entry.id}" class="space-y-2"></div>
                        <div class="mt-3 flex items-center gap-2">
                            <input id="comment-input-${entry.id}" type="text" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." class="comment-input w-full text-sm rounded-lg px-3 py-1 focus:outline-none">
                            <button onclick="addComment('${entry.id}')" class="bg-button text-button text-sm rounded-lg px-3 py-1 hover:bg-opacity-90 transition">å‘é€</button>
                        </div>
                    </div>
                `;
                DOMElements.diaryEntriesContainer.appendChild(entryEl);
                await fetchAndRenderComments(entry.id);
            }
        }

        function triggerFileUpload() { DOMElements.diaryImageUpload.click(); }
        
        function previewImage(event) {
             const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    DOMElements.imagePreview.src = e.target.result;
                    DOMElements.imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            selectedFile = null;
            DOMElements.diaryImageUpload.value = '';
            DOMElements.imagePreview.src = '';
            DOMElements.imagePreviewContainer.classList.add('hidden');
        }
        
        let loveStartDate, timerInterval;
        
        function updateTimerUI(dateISO) {
             loveStartDate = dateISO ? new Date(dateISO) : new Date('2023-01-01T00:00:00');
             if (timerInterval) clearInterval(timerInterval);
             const update = () => {
                const now = new Date();
                const diff = now - loveStartDate;
                document.getElementById('days').textContent = Math.floor(diff / 864e5);
                document.getElementById('hours').textContent = String(Math.floor((diff % 864e5) / 36e5)).padStart(2, '0');
                document.getElementById('minutes').textContent = String(Math.floor((diff % 36e5) / 6e4)).padStart(2, '0');
                document.getElementById('seconds').textContent = String(Math.floor((diff % 6e4) / 1e3)).padStart(2, '0');
             };
             update();
             timerInterval = setInterval(update, 1000);
             document.getElementById('start-date-display').textContent = loveStartDate.toLocaleString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        async function listenForDateUpdates() {
            if (settingsLiveQuery) await settingsLiveQuery.unsubscribe();
            const query = new AV.Query('Settings');
            
            try {
                const setting = await query.first();
                updateTimerUI(setting ? setting.get('startDate') : null);
                settingsLiveQuery = await query.subscribe();
                settingsLiveQuery.on('update', (setting) => updateTimerUI(setting.get('startDate')));
                settingsLiveQuery.on('create', (setting) => updateTimerUI(setting.get('startDate')));
            } catch(e) { console.error("Failed to subscribe to settings:", e); }
        }

        async function setLoveStartDate() {
            const dateValue = document.getElementById('love-start-date').value;
            if (dateValue) {
                const newStartDate = new Date(dateValue);
                const query = new AV.Query('Settings');
                try {
                    let setting = await query.first();
                    if (!setting) {
                        const Settings = AV.Object.extend('Settings');
                        setting = new Settings();
                    }
                    setting.set('startDate', newStartDate.toISOString());
                    await setting.save();
                    toggleSetDate();
                } catch (error) { showAlert("ä¿å­˜çºªå¿µæ—¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            }
        }
        
        function toggleSetDate() { document.getElementById('date-setter').classList.toggle('hidden'); }
        
        async function initApp() {
            listenForUpdates();
        }

        async function connectToCloud() {
            try {
                if (!AV.User.current()) await AV.User.loginAnonymously();
                initApp();
            } catch (error) {
                console.error("LeanCloud connection failed:", error);
                showAlert("æ— æ³•å»ºç«‹å®‰å…¨çš„äº‘ç«¯è¿æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå¹¶åˆ·æ–°é¡µé¢ã€‚");
            }
        }
        
        // --- å¯åŠ¨åº”ç”¨ ---
        connectToCloud();

        // --- å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ ---
        Object.assign(window, {
            selectUser, toggleSetDate, setLoveStartDate, triggerFileUpload,
            previewImage, removeImage, addDiaryEntry, deleteDiaryEntry,
            addComment, deleteComment, hideMessageModal, executeConfirm, scrollToMonth,
            fetchAndRenderComments
        });
    });
    </script>
</body>
</html>

